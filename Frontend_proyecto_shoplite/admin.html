<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - Gestión de Artículos - ShopLite</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>

  <div id="navbar-placeholder"></div>
  <script>
   fetch("navbar.html")
    .then(res => res.text())
    .then(html => {
      document.getElementById("navbar-placeholder").innerHTML = html;

      // Reejecutar los scripts embebidos en navbar.html
      const scripts = document.getElementById("navbar-placeholder").querySelectorAll("script");
      scripts.forEach(script => {
        const nuevoScript = document.createElement("script");
        if (script.src) {
          nuevoScript.src = script.src;
        } else {
          nuevoScript.textContent = script.textContent;
        }
        document.body.appendChild(nuevoScript);
      });

      // Mostrar el nombre del usuario logueado
      const usuario = JSON.parse(localStorage.getItem("usuario"));
      if (usuario) {
        const intervalo = setInterval(() => {
          const contenedorUsuario = document.getElementById("info-usuario");
          const formLogin = document.getElementById("form-login");
          const contenedorInfo = document.getElementById("info-usuario-container");

          if (contenedorUsuario && formLogin && contenedorInfo) {
            contenedorUsuario.textContent = `Hola, ${usuario.nombre}`;
            formLogin.classList.add("d-none");
            contenedorInfo.classList.remove("d-none");
            clearInterval(intervalo);
          }
        }, 100);
      }
    });

  </script>

  <div class="container mt-4">
    <h3>Gestión de Artículos</h3>

    <form id="form-articulo" class="mb-4">
      <input type="hidden" id="idArticulo" />
      <div class="mb-3">
        <label for="nombre" class="form-label">Nombre</label>
        <input type="text" id="nombre" class="form-control" required maxlength="100" />
      </div>
      <div class="mb-3">
        <label for="precio" class="form-label">Precio</label>
        <input type="number" id="precio" class="form-control" step="0.01" min="0" required />
      </div>
      <div class="mb-3">
        <label for="stock" class="form-label">Stock</label>
        <input type="number" id="stock" class="form-control" min="0" required />
      </div>
      <button type="submit" class="btn btn-primary">Guardar</button>
      <button type="button" id="btn-cancelar" class="btn btn-secondary ms-2 d-none">Cancelar</button>
    </form>

    <table class="table table-striped" id="tabla-articulos">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Precio</th>
          <th>Stock</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div id="mensaje" class="alert d-none" role="alert"></div>
  </div>

  <footer class="text-center mt-5 text-muted">
    <p>Desarrollado por Jonatan Chávez para TalentoTech</p>
  </footer>

  <script>
    const tablaBody = document.querySelector("#tabla-articulos tbody");
    const form = document.getElementById("form-articulo");
    const mensaje = document.getElementById("mensaje");
    const btnCancelar = document.getElementById("btn-cancelar");

    // Verifica si es admin
    const usuario = JSON.parse(localStorage.getItem("usuario"));
    if (!usuario || usuario.idTipoUsuario !== 2) {  // Admin es 2
      document.body.innerHTML = '<div class="container mt-5"><div class="alert alert-danger">No tienes permisos para acceder a esta página.</div></div>';
      throw new Error("No autorizado");
    }

    // Carga inicial de artículos
    function cargarArticulos() {
      fetch("http://localhost:8080/api/articulos")
        .then(res => res.json())
        .then(data => {
          tablaBody.innerHTML = "";
          data.forEach(a => {
            const fila = document.createElement("tr");
            fila.innerHTML = `
              <td>${a.nombre}</td>
              <td>$${a.precio.toFixed(2)}</td>
              <td>${a.stock}</td>
              <td>
                <button class="btn btn-sm btn-warning btn-editar" data-id="${a.idArticulo}">Editar</button>
                <button class="btn btn-sm btn-danger btn-eliminar" data-id="${a.idArticulo}">Eliminar</button>
              </td>
            `;
            tablaBody.appendChild(fila);
          });

          // Asignar eventos botones
          document.querySelectorAll(".btn-editar").forEach(btn => {
            btn.addEventListener("click", () => editarArticulo(btn.dataset.id));
          });

          document.querySelectorAll(".btn-eliminar").forEach(btn => {
            btn.addEventListener("click", () => eliminarArticulo(btn.dataset.id));
          });
        })
        .catch(() => {
          mostrarMensaje("Error al cargar artículos", "danger");
        });
    }

    // Mostrar mensaje
    function mostrarMensaje(texto, tipo = "success") {
      mensaje.textContent = texto;
      mensaje.className = `alert alert-${tipo}`;
      mensaje.classList.remove("d-none");
      setTimeout(() => mensaje.classList.add("d-none"), 3000);
    }

    // Guardar nuevo o actualizar artículo
    form.addEventListener("submit", e => {
      e.preventDefault();
      const id = document.getElementById("idArticulo").value;
      const nombre = document.getElementById("nombre").value.trim();
      const precio = parseFloat(document.getElementById("precio").value);
      const stock = parseInt(document.getElementById("stock").value);

      const articulo = { nombre, precio, stock };

      if (id) {
        // Actualizar
        fetch(`http://localhost:8080/api/articulos/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(articulo),
        })
          .then(res => {
            if (!res.ok) throw new Error("Error actualizando");
            return res.json();
          })
          .then(() => {
            mostrarMensaje("Artículo actualizado");
            form.reset();
            btnCancelar.classList.add("d-none");
            cargarArticulos();
          })
          .catch(() => mostrarMensaje("Error al actualizar artículo", "danger"));
      } else {
        // Crear nuevo
        fetch("http://localhost:8080/api/articulos", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(articulo),
        })
          .then(res => {
            if (!res.ok) throw new Error("Error creando");
            return res.json();
          })
          .then(() => {
            mostrarMensaje("Artículo creado");
            form.reset();
            cargarArticulos();
          })
          .catch(() => mostrarMensaje("Error al crear artículo", "danger"));
      }
    });

    // Editar artículo: cargar datos en el formulario
    function editarArticulo(id) {
      fetch(`http://localhost:8080/api/articulos/${id}`)
        .then(res => res.json())
        .then(data => {
          document.getElementById("idArticulo").value = data.idArticulo;
          document.getElementById("nombre").value = data.nombre;
          document.getElementById("precio").value = data.precio;
          document.getElementById("stock").value = data.stock;
          btnCancelar.classList.remove("d-none");
        })
        .catch(() => mostrarMensaje("Error al cargar artículo", "danger"));
    }

    // Cancelar edición
    btnCancelar.addEventListener("click", () => {
      form.reset();
      document.getElementById("idArticulo").value = "";
      btnCancelar.classList.add("d-none");
    });

    // Eliminar artículo
    function eliminarArticulo(id) {
      if (!confirm("¿Seguro querés eliminar este artículo?")) return;
      fetch(`http://localhost:8080/api/articulos/${id}`, { method: "DELETE" })
        .then(res => {
          if (!res.ok) throw new Error("Error eliminando");
          mostrarMensaje("Artículo eliminado");
          cargarArticulos();
        })
        .catch(() => mostrarMensaje("Error al eliminar artículo", "danger"));
    }

    cargarArticulos();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>