<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="index.html">ShopLite</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item">
          <a class="nav-link active" href="index.html">Inicio</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="carrito.html">Carrito</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="mis-pedidos.html">Mis Pedidos</a>
        </li>
      </ul>

      <div class="d-flex align-items-center">
        <form id="form-login" class="d-flex" onsubmit="loginUsuario(event)">
          <input class="form-control me-2" type="text" id="nombreUsuario" placeholder="Usuario" required>
          <input class="form-control me-2" type="password" id="claveUsuario" placeholder="Clave" required>
          <button class="btn btn-outline-light" type="submit">Ingresar</button>
          <button class="btn btn-outline-light ms-2" type="button" data-bs-toggle="modal" data-bs-target="#modalRegistro">
            Registrarse
          </button>
        </form>

        <div id="info-usuario-container" class="d-none">
          <span class="text-white me-2" id="info-usuario"></span>
          <button class="btn btn-outline-light btn-sm" onclick="cerrarSesion()">Cerrar sesión</button>
        </div>
      </div>
    </div>
  </div>
</nav>

<!-- Modal de Registro -->
<div class="modal fade" id="modalRegistro" tabindex="-1" aria-labelledby="modalRegistroLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form onsubmit="registrarUsuario(event)">
        <div class="modal-header">
          <h5 class="modal-title" id="modalRegistroLabel">Registro de Usuario</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" class="form-control mb-2" placeholder="Nombre" id="registroNombre" required>
          <input type="password" class="form-control mb-2" placeholder="Clave (mínimo 6 caracteres)" id="registroClave" required>
          <input type="text" class="form-control mb-2" placeholder="DNI (8 dígitos)" id="registroDni" required>
          <input type="text" class="form-control mb-2" placeholder="Dirección" id="registroDireccion">
          <input type="text" class="form-control mb-2" placeholder="Teléfono" id="registroTelefono">
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Registrarse</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  function registrarUsuario(event) {
    event.preventDefault();

    const nombre = document.getElementById("registroNombre").value;
    const clave = document.getElementById("registroClave").value;
    const dni = document.getElementById("registroDni").value;

    if (dni.length !== 8 || isNaN(dni)) {
      alert("El DNI debe tener 8 dígitos numéricos.");
      return;
    }
    if (clave.length < 6) {
      alert("La clave debe tener al menos 6 caracteres.");
      return;
    }

    const nuevoUsuario = {
      nombre,
      clave,
      dni,
      direccion: document.getElementById("registroDireccion").value,
      telefono: document.getElementById("registroTelefono").value,
      estado: true,
      idTipoUsuario: 1
    };

    fetch("http://localhost:8080/api/usuarios", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(nuevoUsuario)
    })
    .then(res => {
      if (!res.ok) {
        return res.text().then(msg => {
          throw new Error("Error al registrar usuario: " + msg);
        });
      }
      return res.json();
    })
    .then(usuario => {
      alert("Usuario registrado correctamente");
      localStorage.setItem("usuario", JSON.stringify(usuario));
      document.querySelector("#modalRegistro .btn-close").click();
      location.reload(); // Para que se oculte el login y se muestre el nombre
    })
    .catch(error => {
      alert(error.message);
    });
  }

  function loginUsuario(event) {
    event.preventDefault();
    const nombre = document.getElementById("nombreUsuario").value;
    const clave = document.getElementById("claveUsuario").value;

    fetch("http://localhost:8080/api/usuarios")
      .then(res => res.json())
      .then(usuarios => {
        const usuario = usuarios.find(u => u.nombre === nombre && u.clave === clave);
        if (usuario) {
          localStorage.setItem("usuario", JSON.stringify(usuario));
          location.reload();
        } else {
          alert("Usuario o clave incorrectos");
        }
      });
  }

  function cerrarSesion() {
    localStorage.removeItem("usuario");
    location.reload();
  }

  // Mostrar el nombre si está logueado
  window.addEventListener("DOMContentLoaded", () => {
    const usuario = JSON.parse(localStorage.getItem("usuario"));
    if (usuario) {
      document.getElementById("form-login").classList.add("d-none");
      document.getElementById("info-usuario-container").classList.remove("d-none");
      document.getElementById("info-usuario").textContent = `Hola, ${usuario.nombre}`;
    }
  });
</script>
